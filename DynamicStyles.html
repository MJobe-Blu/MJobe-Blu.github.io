<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Jotform Company Styling Widget</title>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            font-size: 14px;
        }
        .widget-container {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
        }
        .info {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <h3>Company Styling Widget</h3>
        <p>Enter JSON configuration for company styles below:</p>
        <textarea id="stylesConfig" placeholder='{"Company1": {"backgroundColor": "#f5f5f5", "fontFamily": "Arial", "textColor": "#333333", "accentColor": "#0066cc"}}'>
        </textarea>
        <p>Company Selection Field ID: <input type="text" id="companyFieldId" placeholder="e.g., input_10"></p>
        <div class="info">Current company: <span id="currentCompany">None selected</span></div>
    </div>

    <script>
        // Global variables
        let stylesConfig = {};
        let companyFieldId = '';
        let JFCustomWidget;
        
        function onLoadCallback() {
            JFCustomWidget = JotformCustomWidget.initialize({
                "frameHeight": 300,
                "widgetId": ""
            });
            
            // Ready event
            JFCustomWidget.subscribe("ready", function() {
                const settings = JFCustomWidget.getWidgetSettings();
                
                if (settings.stylesConfig) {
                    document.getElementById('stylesConfig').value = settings.stylesConfig;
                    try {
                        stylesConfig = JSON.parse(settings.stylesConfig);
                    } catch (e) {
                        console.error("Invalid JSON in styles config", e);
                    }
                }
                
                if (settings.companyFieldId) {
                    document.getElementById('companyFieldId').value = settings.companyFieldId;
                    companyFieldId = settings.companyFieldId;
                }
                
                document.getElementById('stylesConfig').addEventListener('change', saveSettings);
                document.getElementById('companyFieldId').addEventListener('change', saveSettings);
                
                JFCustomWidget.subscribe("formValueChanged", handleFormValueChange);
            });
        }
        
        function saveSettings() {
            stylesConfig = document.getElementById('stylesConfig').value;
            companyFieldId = document.getElementById('companyFieldId').value;
            
            JFCustomWidget.saveWidgetSettings({
                stylesConfig: stylesConfig,
                companyFieldId: companyFieldId
            });
        }
        
        function handleFormValueChange(data) {
            if (data.fieldID === companyFieldId) {
                const companyName = data.value;
                document.getElementById('currentCompany').textContent = companyName || 'None selected';
                
                applyCompanyStyles(companyName);
            }
        }
        
        function applyCompanyStyles(companyName) {
            try {
                const styles = JSON.parse(stylesConfig)[companyName];
                if (!styles) return;
                
                let styleEl = document.getElementById('company-styles');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'company-styles';
                    document.head.appendChild(styleEl);
                }
                
                let css = `
                    /* Company styling for ${companyName} */
                    .form-all {
                        background-color: ${styles.backgroundColor || '#ffffff'} !important;
                        font-family: ${styles.fontFamily || 'inherit'} !important;
                        color: ${styles.textColor || 'inherit'} !important;
                    }
                    .form-label-left, .form-label-right, .form-label {
                        color: ${styles.textColor || 'inherit'} !important;
                    }
                    .form-submit-button, .form-submit-reset, .form-submit-print {
                        background-color: ${styles.accentColor || '#2e69ff'} !important;
                    }
                `;
                
                // Apply additional custom styles if provided
                if (styles.customCSS) {
                    css += styles.customCSS;
                }
                
                styleEl.textContent = css;
                
                JFCustomWidget.executeAsyncScript({
                    script: `
                        (function() {
                            let styleEl = document.getElementById('company-styles');
                            if (!styleEl) {
                                styleEl = document.createElement('style');
                                styleEl.id = 'company-styles';
                                document.head.appendChild(styleEl);
                            }
                            styleEl.textContent = ${JSON.stringify(css)};
                        })();
                    `
                });
                
            } catch (e) {
                console.error("Error applying styles", e);
            }
        }
    </script>
</body>
</html>