<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- JotForm Custom Widget -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
</head>
<body>
    <div id="dropdownsContainer"></div>
    <script>
        "use strict";

        window.addEventListener('load', function () {

            function CustomDynamicDropdown(containerID, formData) {
                var params = JFCustomWidget.getWidgetSettings();
                var separator = (params.separator && params.separator != '<empty>' ? ' ' + params.separator + ' ' : "\n");
                var list = [];

                // exposed functions
                this.init = init;
                this.getData = getData;
                this.clearValues = clearValues;

                function getData() {
                    var values = [];
                    $('#' + containerID + ' select').each(function (index, element) {
                        values.push($(element).val());
                        // if the item is required or the whole widget is required
                        // and no value, make the values empty to trigger validation
                        if ((JFCustomWidget.isWidgetRequired() ||
                            $(element).attr('required')) && !$(element).val()) {
                            values = [];
                            return false;
                        }
                    });

                    values = values.join(separator);

                    return {
                        valid: !!values,
                        value: values
                    };
                }

                function setData(data) {
                    var level = 0;
                    data = data.split(separator);
                    for (var x in data) {
                        var row = cleanValueForSetData(data[x]);
                        var dropdown = $('#' + containerID + ' select')[level];
                        $(dropdown).val(row).trigger('change.select2');
                        level += 1;
                    }
                    resizeIframe();
                }

                function init() {
                    var tree = parseList(params.list);
                    showDropdown(tree);
                    if (formData && formData.value) {
                        setData(formData.value);
                    } else if ($('#' + containerID + ' select option:selected').val()) {
                        updateWidgetValue();
                    }
                    if (!$('#' + containerID + ' select option:selected').val() && !JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetNotRequired();
                    }
                    $(window).on('resize', resizeIframe);
                }

                function parseList(text) {
                    var path = [];
                    var hasRequired = false;

                    // var data = text.replace(/\r/, '').replace(/\n+/g, '\n').split('\n');
                    if (text) {
                        var data = text.split(/\r\n|\r|\n/g);
                        for (var index in data) {
                            var item = data[index];
                            var depth = getDepth(item);
                            var parentIndex = -1;

                            item = item.trim();
                            // rendering issue with characters when many entries
                            item = item.replace(/&amp;amp;/g, "&")
                                .replace(/&amp;#39;/g, "'")
                                .replace(/&amp;lt;/g, "<")
                                .replace(/&amp;gt;/g, ">")
                                .replace(/&amp;quot;/g, '"')
                                .replace(/&amp;/g, "&")
                                .replace(/&#39;/g, "'")
                                .replace(/&lt;/g, "<")
                                .replace(/&gt;/g, ">")
                                .replace(/&quot;/g, '"');

                            // add + to digit property of object

                            // the last path element with depth smaller than my depth is my parent
                            for (var i = 0; i < path.length; i++) {
                                if (depth <= path[i].depth) {
                                    break;
                                }
                                parentIndex = i;
                            }

                            // delete descendants of my parent (if any) and add myself instead
                            while (path.length > parentIndex + 1) {
                                path.pop();
                            }

                            path.push({
                                'index': index,
                                'depth': depth,
                            });

                            // list with node values and its parents will allow us to easily build a tree
                            var isItemRequired = item.match(/^ *\*/); // "*" at the beginning stands for required value
                            if (!hasRequired && isItemRequired) {
                                hasRequired = true;
                            }

                            list.push({
                                'value': cleanValue(item),
                                'parent': parentIndex >= 0 ? Number(path[parentIndex].index) : null,
                                'required': isItemRequired
                            });
                        }
                    }

                    // make the widget required internally
                    // if there's atleast one item is requred
                    if (hasRequired) {
                        makeWidgetRequiredOrNot();
                    }

                    return getValuesForNode(list, null);
                }

                function getDepth(str) {
                    var depth = 0;
                    while (str[depth] === ' ') {
                        depth++;
                    }
                    return depth;
                }

                function cleanValue(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*/, '');

                    // "." stands for empty value
                    if (str === '.') {
                        str = '';
                    }

                    // added this for situation when number is required;
                    // we should adding to all numbers + in the begin;
                    // and checking + in position 0
                    return str;
                }

                function cleanValueForSetData(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*$/, '');

                    // "." stands for empty value
                    if (str === '.') {
                        str = '';
                    }

                    return str;
                }

                // recursive conversion from list to tree format
                function getValuesForNode(list, parent) {
                    var out = {
                        'values': {},
                        'required': false,
                    };

                    for (var index = 0; index < list.length; index++) {
                        var item = list[index];
                        if (item.parent === parent) {
                            out.values[item.value] = getValuesForNode(list, index);

                            if (item.parent !== null && list[item.parent].required) {
                                out.required = true;
                            }
                        }
                    }

                    return out;
                }

                // for sorting digital properies for object
                function changeToString(str) {
                    if (!isNaN(str) && str != "") {
                        str = str + '';
                    }

                    return str;
                }

                function makeWidgetRequiredOrNot() {
                    if (!JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetRequired();
                    }
                }

                // display dropdown for a chosen node
                function showDropdown(node, level) {

                    if (!level) {
                        level = 0;
                    }

                    // elements of level N have all class names with levels 0..N so by removing level X we also remove all levels > X
                    $('#' + containerID + ' select.dd-' + level).select2('destroy');
                    $('#' + containerID + ' select.dd-' + level).remove();
                    if (!node || !Object.keys(node.values).length) {
                        resizeIframe();
                        return;
                    }

                    var $dropdown = $('<select>', {
                        'class': getDropdownClass(level),
                        'required': node.required,
                    });

                    var objectKeys = Object.keys(node.values);

                    // this for save empty space and append to the begin of node
                    var selectEmpty = [];

                    for (var index in objectKeys) {
                        var key = objectKeys[index];

                        // if key == select, save key and go to next iteration
                        if (key === "") {
                            selectEmpty.push(key);
                        } else {
                            $('<option>', {
                                'value': key,
                            }).html(key).appendTo($dropdown);
                        }
                    }

                    // append to the end select if exist
                    if (selectEmpty.length > 0) {
                        for (var index in selectEmpty) {
                            $('<option>', {
                                'value': ""
                            }).html(selectEmpty[index]).prependTo($dropdown);
                            $dropdown.val($($dropdown).find("option[selected]").val());
                        }
                    }

                    if (params.inputHint && params.inputHint != '<empty>') {
                        $('<option>', {
                            'value': ''
                        }).html(params.inputHint).prependTo($dropdown);
                    }

                    $dropdown.on('change', function () {
                        if (this.selectedIndex == 0) {
                            // if the current dropdown is cleared, delete all descendants
                            showDropdown([], level + 1);
                        } else {
                            var value = $(this).val();
                            if (typeof value !== 'undefined') {
                                showDropdown(node.values[value], level + 1);
                                if (node.values[value].required) {
                                    makeWidgetRequiredOrNot();
                                }
                            }
                        }
                        updateWidgetValue();
                    });

                    $('#' + containerID).append($dropdown);
                    if ($dropdown.length) {
                        $dropdown.select2();
                    }
                }

                function updateWidgetValue() {
                    var data = getData();
                    JFCustomWidget.sendSubmit(data);
                    JFCustomWidget.setWidgetValue(data.value);
                }

                function clearValues() {
                    $('#' + containerID + ' select').val('').trigger('change.select2');
                    resizeIframe();
                }

                function getDropdownClass(level) {
                    return 'form-control dd-' + level;
                }

                function resizeIframe() {
                    setTimeout(function () {
                        JFCustomWidget.requestFrameResize();
                    }, 300);
                }

            }

            var customDynamicDropdown = new CustomDynamicDropdown('dropdownsContainer', JFCustomWidget.getWidgetData());
            JFCustomWidget.subscribe('ready', customDynamicDropdown.init);
            JFCustomWidget.subscribe('submit', customDynamicDropdown.getData);
            JFCustomWidget.subscribe('reset', customDynamicDropdown.clearValues);

        });

    </script>
</body>
</html>
