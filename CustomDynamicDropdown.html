<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- JotForm Custom Widget -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
</head>
<body>
    <div id="dropdownsContainer"></div>
    <script>
        "use strict";

        window.addEventListener('load', function () {

            function CustomDynamicDropdown(containerID, formData) {
                var params = JFCustomWidget.getWidgetSettings();
                var separator = (params.separator && params.separator != '<empty>' ? ' ' + params.separator + ' ' : "\n");
                var list = [];

                // exposed functions
                this.init = init;
                this.getData = getData;
                this.clearValues = clearValues;

                function getData() {
                    var values = [];
                    $('#' + containerID + ' select').each(function (index, element) {
                        values.push($(element).val());
                        // if the item is required or the whole widget is required
                        // and no value, make the values empty to trigger validation
                        if ((JFCustomWidget.isWidgetRequired() ||
                            $(element).attr('required')) && !$(element).val()) {
                            values = [];
                            return false;
                        }
                    });

                    values = values.join(separator);

                    return {
                        valid: !!values,
                        value: values
                    };
                }

                function setData(data) {
                    var level = 0;
                    data = data.split(separator);
                    for (var x in data) {
                        var row = cleanValueForSetData(data[x]);
                        var dropdown = $('#' + containerID + ' select')[level];
                        $(dropdown).val(row).trigger('change.select2');
                        level += 1;
                    }
                    resizeIframe();
                }

                function init() {
                    var tree = parseList(params.list);
                    showDropdown(tree);
                    if (formData && formData.value) {
                        setData(formData.value);
                    } else if ($('#' + containerID + ' select option:selected').val()) {
                        updateWidgetValue();
                    }
                    if (!$('#' + containerID + ' select option:selected').val() && !JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetNotRequired();
                    }
                    $(window).on('resize', resizeIframe);
                }

                function parseList(text) {
                    var path = [];
                    var hasRequired = false;

                    // var data = text.replace(/\r/, '').replace(/\n+/g, '\n').split('\n');
                    if (text) {
                        var data = text.split(/\r\n|\r|\n/g);
                        for (var index in data) {
                            var item = data[index];
                            var depth = getDepth(item);
                            var parentIndex = -1;

                            item = item.trim();
                            // rendering issue with characters when many entries
                            item = item.replace(/&amp;amp;/g, "&")
                                .replace(/&amp;#39;/g, "'")
                                .replace(/&amp;lt;/g, "<")
                                .replace(/&amp;gt;/g, ">")
                                .replace(/&amp;quot;/g, '"')
                                .replace(/&amp;/g, "&")
                                .replace(/&#39;/g, "'")
                                .replace(/&lt;/g, "<")
                                .replace(/&gt;/g, ">")
                                .replace(/&quot;/g, '"');

                            // add + to digit property of object

                            // the last path element with depth smaller than my depth is my parent
                            for (var i = 0; i < path.length; i++) {
                                if (depth <= path[i].depth) {
                                    break;
                                }
                                parentIndex = i;
                            }

                            // delete descendants of my parent (if any) and add myself instead
                            while (path.length > parentIndex + 1) {
                                path.pop();
                            }

                            path.push({
                                'index': index,
                                'depth': depth,
                            });

                            // list with node values and its parents will allow us to easily build a tree
                            var isItemRequired = item.match(/^ *\*/); // "*" at the beginning stands for required value
                            if (!hasRequired && isItemRequired) {
                                hasRequired = true;
                            }

                            list.push({
                                'value': cleanValue(item),
                                'parent': parentIndex >= 0 ? Number(path[parentIndex].index) : null,
                                'required': isItemRequired
                            });
                        }
                    }

                    // make the widget required internally
                    // if there's atleast one item is requred
                    if (hasRequired) {
                        makeWidgetRequiredOrNot();
                    }

                    return getValuesForNode(list, null);
                }

                function getDepth(str) {
                    var depth = 0;
                    while (str[depth] === ' ') {
                        depth++;
                    }
                    return depth;
                }

                function cleanValue(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*/, '');

                    // "." stands for empty value
                    if (str === '.') {
                        str = '';
                    }

                    // added this for situation when number is required;
                    // we should adding to all numbers + in the begin;
                    // and checking + in position 0
                    return str;
                }

                function cleanValueForSetData(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*$/, '');

                    // "." stands for empty value
                    if (str === '.') {
                        str = '';
                    }

                    return str;
                }

                // recursive conversion from list to tree format
                function getValuesForNode(list, parent) {
                    var out = {
                        'values': {},
                        'required': false,
                    };

                    for (var index = 0; index < list.length; index++) {
                        var item = list[index];
                        if (item.parent === parent) {
                            out.values[item.value] = getValuesForNode(list, index);

                            if (item.parent !== null && list[item.parent].required) {
                                out.required = true;
                            }
                        }
                    }

                    return out;
                }

                // for sorting digital properies for object
                function changeToString(str) {
                    if (!isNaN(str) && str != "") {
                        str = str + '';
                    }

                    return str;
                }

                function makeWidgetRequiredOrNot() {
                    if (!JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetRequired();
                    }
                }

                // display dropdown for a chosen node
                function showDropdown(node, level) {

                    if (!level) {
                        level = 0;
                    }

                    // elements of level N have all class names with levels 0..N so by removing level X we also remove all levels > X
                    $('#' + containerID + ' select.dd-' + level).select2('destroy');
                    $('#' + containerID + ' select.dd-' + level).remove();
                    if (!node || !Object.keys(node.values).length) {
                        resizeIframe();
                        return;
                    }

                    var $dropdown = $('<select>', {
                        'class': getDropdownClass(level),
                        'required': node.required,
                    });

                    var objectKeys = Object.keys(node.values);

                    // this for save empty space and append to the begin of node
                    var selectEmpty = [];

                    for (var index in objectKeys) {
                        var key = objectKeys[index];

                        // if key == select, save key and go to next iteration
                        if (key === "") {
                            selectEmpty.push(key);
                        } else {
                            $('<option>', {
                                'value': key,
                            }).html(key).appendTo($dropdown);
                        }
                    }

                    // append to the end select if exist
                    if (selectEmpty.length > 0) {
                        for (var index in selectEmpty) {
                            $('<option>', {
                                'value': ""
                            }).html(selectEmpty[index]).prependTo($dropdown);
                            $dropdown.val($($dropdown.attr("class") + " option:first").val());
                        }
                    }

                    // $dropdown.bind('change', function() {
                    //   //change to String for object property
                    //   showDropdown(node.values[changeToString(this.value)], level + 1);
                    //   updateWidgetValue();
                    // });

                    $dropdown.appendTo('#' + containerID);

                    $dropdown.select2({
                        placeholder: "Please select",
                        dropdownPosition: 'below'
                    }).on("select2:close", function () {
                        resizeIframe();
                    }).on("select2:open", function (e) {
                        resizeIframe();
                        /*
                        //patch that addresses #4209507. We may need to refactor this to work better rather than firing the iframe resize twice.
                        if(getAndroidVersion() === '11' || getAndroidVersion() === '12'){
                          resizeIframe();
                        }
                        //end of patch
                        $('.select2-dropdown').hide();
                        setTimeout(function() {
                
                          var interval;
                
                          $('.select2-dropdown').fadeIn('fast', function() {
                            if (interval) {
                              clearInterval(interval);
                            }
                          });
                
                          interval = setInterval(function() {
                            resizeIframe();
                          }, 50);
                        }, 150);
                        */
                    }).on('select2:select', function (e) {
                        var value = $(this).val();

                        if (value) {
                            showDropdown(node.values[changeToString(this.value)], level + 1);
                            updateWidgetValue();
                        }
                    }).on('change.select2', function (e) {
                        var value = $(this).val();

                        if (value) {
                            showDropdown(node.values[changeToString(this.value)], level + 1);
                            updateWidgetValue();
                        }

                        var indexOfValue = list.map(function (o) { return o.value; }).indexOf(value);

                        if (indexOfValue !== -1 && list[indexOfValue].required !== null) {
                            JFCustomWidget.makeWidgetRequired();
                        }

                    });

                    // change to String for object property
                    showDropdown(node.values[changeToString($dropdown.val())], level + 1);

                    hideEmptySelect();
                }

                // returns combined class names for all levels from 0 to N (allowing us to easily drop child elements using level only)
                function getDropdownClass(level) {
                    var className = '';
                    for (var i = 0; i <= level; i++) {
                        className += 'dd-' + i + ' ';
                    }
                    return className;
                }

                function updateWidgetValue() {
                    JFCustomWidget.sendData(getData());
                }

                function resizeIframe() {
                    if (!JFCustomWidget) {
                        return false;
                    }

                    var bodyHeight = $('body').height();
                    var height = bodyHeight;

                    var selectDropdownTopOffsetA = (parseInt($('.select2-dropdown').parent().css('top')) || 0);
                    if (selectDropdownTopOffsetA < 0) {
                        $('.select2-dropdown').parent().css('top', 0);
                        var selectDropdownHeight = ($('.select2-dropdown').height() || 0);
                        height = bodyHeight + selectDropdownHeight + 20;
                    } else {
                        var selectDropdownHeight = ($('.select2-dropdown').height() || 0);
                        var selectDropdownTopOffset = (parseInt($('.select2-dropdown').parent().css('top')) || 0);

                        if ((selectDropdownTopOffset + selectDropdownHeight) >= bodyHeight) {
                            height = selectDropdownTopOffset + selectDropdownHeight + 20;
                        }
                    }

                    // always 100% on card forms
                    if ('cardform' in formData && formData.cardform) {
                        return JFCustomWidget.requestFrameResize({
                            width: '99.9%',
                            height: height
                        });
                    }

                    JFCustomWidget.requestFrameResize({
                        width: $('body').width(),
                        height: height
                    });
                }

                function hideEmptySelect() {
                    $('#' + containerID + ' select').each(function (index, element) {
                        if ($(element).val() == "") {
                            if ($(element).find('option').length == 1 && $(element).find('option').text() == "") {
                                $(element).hide();
                                resizeIframe();
                            }
                        }
                    });
                }

                function clearValues() {
                    var level = 0;
                    var selectsCount = $('#' + containerID + ' select').length;
                    while (level <= selectsCount) {
                        var dropdown = $('#' + containerID + ' select')[level];
                        $(dropdown).val('').trigger('change.select2');
                        level += 1;
                    }
                    resizeIframe();
                }

                //Detect Android version
                function getAndroidVersion(ua) {
                    ua = (ua || navigator.userAgent).toLowerCase();
                    var match = ua.match(/android\s([0-9\.]*)/i);
                    return match ? match[1] : undefined;
                };

            }

            JFCustomWidget.subscribe('ready', function (data) {
                var widget = new CustomDynamicDropdown('dropdownsContainer', data);
                widget.init();

                JFCustomWidget.subscribe('clear', widget.clearValues);
                JFCustomWidget.subscribe('submit', function () {
                    JFCustomWidget.sendSubmit(widget.getData());
                });
            });

        });
    </script>
</body>

</html>