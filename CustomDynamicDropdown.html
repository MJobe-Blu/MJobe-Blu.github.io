<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- JotForm Custom Widget -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
</head>
<body>
    <div id="dropdownsContainer"></div>
    <script>
        "use strict";

        window.addEventListener('load', function () {
            function CustomDynamicDropdown(containerID, formData) {
                var params = JFCustomWidget.getWidgetSettings();
                console.log("params:", params);
                console.log("getWidgetSettings:", JFCustomWidget.getWidgetSettings())
                console.log("separator1:", params?.separator)
                console.log("separator2:", params?.Separator)

                var separator = (params.separator && params.separator != '<empty>' ? ' ' + params.separator + ' ' : "\n");
                var list = [];

                // exposed functions
                this.init = init;
                this.getData = getData;
                this.clearValues = clearValues;

                function getData() {
                    var values = [];
                    $('#' + containerID + ' select').each(function (index, element) {
                        values.push($(element).val());
                        if ((JFCustomWidget.isWidgetRequired() || $(element).attr('required')) && !$(element).val()) {
                            values = [];
                            return false;
                        }
                    });

                    values = values.join(separator);

                    return {
                        valid: !!values,
                        value: values
                    };
                }

                function setData(data) {
                    var level = 0;
                    data = data.split(separator);
                    for (var x in data) {
                        var row = cleanValueForSetData(data[x]);
                        var dropdown = $('#' + containerID + ' select')[level];
                        $(dropdown).val(row).trigger('change.select2');
                        level += 1;
                    }
                    resizeIframe();
                }

                function init() {
                    var params2 = JFCustomWidget?.getWidgetSetting("Values");
                    console.log("params2:", params2);
                    console.log("getWidgetSettings2:", JFCustomWidget.getWidgetSettings())
                    var tree = parseList(params.list);
                    showDropdown(tree);
                    if (formData && formData.value) {
                        setData(formData.value);
                    } else if ($('#' + containerID + ' select option:selected').val()) {
                        updateWidgetValue();
                    }
                    if (!$('#' + containerID + ' select option:selected').val() && !JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetNotRequired();
                    }
                    $(window).on('resize', resizeIframe);
                }

                function parseList(text) {
                    var path = [];
                    var hasRequired = false;

                    if (text) {
                        var data = text.split(/\r\n|\r|\n/g);
                        for (var index in data) {
                            var item = data[index];
                            var depth = getDepth(item);
                            var parentIndex = -1;

                            item = item.trim();
                            item = item.replace(/&amp;amp;/g, "&")
                                .replace(/&amp;#39;/g, "'")
                                .replace(/&amp;lt;/g, "<")
                                .replace(/&amp;gt;/g, ">")
                                .replace(/&amp;quot;/g, '"')
                                .replace(/&amp;/g, "&")
                                .replace(/&#39;/g, "'")
                                .replace(/&lt;/g, "<")
                                .replace(/&gt;/g, ">")
                                .replace(/&quot;/g, '"');

                            for (var i = 0; i < path.length; i++) {
                                if (depth <= path[i].depth) {
                                    break;
                                }
                                parentIndex = i;
                            }

                            while (path.length > parentIndex + 1) {
                                path.pop();
                            }

                            path.push({
                                'index': index,
                                'depth': depth,
                            });

                            var isItemRequired = item.match(/^ *\*/);
                            if (!hasRequired && isItemRequired) {
                                hasRequired = true;
                            }

                            list.push({
                                'value': cleanValue(item),
                                'parent': parentIndex >= 0 ? Number(path[parentIndex].index) : null,
                                'required': isItemRequired
                            });
                        }
                    }

                    if (hasRequired) {
                        makeWidgetRequiredOrNot();
                    }

                    return getValuesForNode(list, null);
                }

                function getDepth(str) {
                    var depth = 0;
                    while (str[depth] === ' ') {
                        depth++;
                    }
                    return depth;
                }

                function cleanValue(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*/, '');
                    if (str === '.') {
                        str = '';
                    }
                    return str;
                }

                function cleanValueForSetData(str) {
                    str = str.replace(/\r/, '').replace(/^ +/, '').replace(/ +$/, '').replace(/^\*$/, '');
                    if (str === '.') {
                        str = '';
                    }
                    return str;
                }

                function getValuesForNode(list, parent) {
                    var out = {
                        'values': {},
                        'required': false,
                    };

                    for (var index = 0; index < list.length; index++) {
                        var item = list[index];
                        if (item.parent === parent) {
                            out.values[item.value] = getValuesForNode(list, index);
                            if (item.parent !== null && list[item.parent].required) {
                                out.required = true;
                            }
                        }
                    }

                    return out;
                }

                function changeToString(str) {
                    if (!isNaN(str) && str != "") {
                        str = str + '';
                    }
                    return str;
                }

                function makeWidgetRequiredOrNot() {
                    if (!JFCustomWidget.isWidgetRequired()) {
                        JFCustomWidget.makeWidgetRequired();
                    }
                }

                function showDropdown(node, level) {
                    if (!level) {
                        level = 0;
                    }

                    $('#' + containerID + ' select.dd-' + level).select2('destroy');
                    $('#' + containerID + ' select.dd-' + level).remove();
                    if (!node || !Object.keys(node.values).length) {
                        resizeIframe();
                        return;
                    }

                    var $dropdown = $('<select>', {
                        'class': getDropdownClass(level),
                        'required': node.required,
                    });

                    var objectKeys = Object.keys(node.values);
                    var selectEmpty = [];

                    for (var index in objectKeys) {
                        var key = objectKeys[index];
                        if (key === "") {
                            selectEmpty.push(key);
                        } else {
                            $('<option>', {
                                'value': key,
                            }).html(key).appendTo($dropdown);
                        }
                    }

                    if (selectEmpty.length > 0) {
                        for (var index in selectEmpty) {
                            $('<option>', {
                                'value': ""
                            }).html(selectEmpty[index]).prependTo($dropdown);
                            $dropdown.val($($dropdown.attr("class") + " option:first").val());
                        }
                    }

                    $dropdown.appendTo('#' + containerID);

                    $dropdown.select2({
                        placeholder: "Please select",
                        dropdownPosition: 'below'
                    }).on("select2:close", function () {
                        resizeIframe();
                    }).on("select2:open", function (e) {
                        resizeIframe();
                    }).on('select2:select', function (e) {
                        var value = $(this).val();
                        if (value) {
                            showDropdown(node.values[changeToString(this.value)], level + 1);
                            updateWidgetValue();
                        }
                    }).on('change.select2', function (e) {
                        var value = $(this).val();
                        if (value) {
                            showDropdown(node.values[changeToString(this.value)], level + 1);
                            updateWidgetValue();
                        }
                        var indexOfValue = list.map(function (o) { return o.value; }).indexOf(value);
                        if (indexOfValue !== -1 && list[indexOfValue].required !== null) {
                            JFCustomWidget.makeWidgetRequired();
                        }
                    });

                    showDropdown(node.values[changeToString($dropdown.val())], level + 1);
                    hideEmptySelect();
                }

                function getDropdownClass(level) {
                    var className = '';
                    for (var i = 0; i <= level; i++) {
                        className += 'dd-' + i + ' ';
                    }
                    return className;
                }

                function updateWidgetValue() {
                    JFCustomWidget.sendData(getData());
                }

                function resizeIframe() {
                    if (!JFCustomWidget) {
                        return false;
                    }

                    var bodyHeight = $('body').height();
                    var height = bodyHeight;

                    var selectDropdownTopOffsetA = (parseInt($('.select2-dropdown').parent().css('top')) || 0);
                    var selectDropdownTopOffsetB = parseInt($('.select2-dropdown').css('top')) || 0;
                    var selectDropdownBottomOffset = parseInt($('.select2-dropdown').css('bottom')) || 0;

                    if (selectDropdownTopOffsetA > 0) {
                        height += selectDropdownTopOffsetA;
                    }

                    if (selectDropdownTopOffsetB > 0) {
                        height += selectDropdownTopOffsetB;
                    }

                    if (selectDropdownBottomOffset < 0) {
                        height += Math.abs(selectDropdownBottomOffset);
                    }

                    JFCustomWidget.requestFrameResize({
                        height: height + 20,
                    });
                }

                function clearValues() {
                    $('#' + containerID).find('select').each(function (index, element) {
                        $(element).select2('destroy');
                        $(element).remove();
                    });
                    showDropdown(parseList(params.list));
                    updateWidgetValue();
                }

                function hideEmptySelect() {
                    var $select = $('#' + containerID + ' select');
                    var hideSelect = $select.length - 1;

                    for (var index = $select.length - 1; index >= 0; index--) {
                        var hasSelectedOption = $($select[index]).val();
                        if (hideSelect === index) {
                            if (hasSelectedOption === "") {
                                $($select[index]).remove();
                                hideSelect -= 1;
                            }
                        }
                    }
                }
            }

            var Widget;

            JFCustomWidget.subscribe("ready", function (data) {
                Widget = new CustomDynamicDropdown("dropdownsContainer", data);
                Widget.init();
            });

            JFCustomWidget.subscribe("submit", function () {
                JFCustomWidget.sendSubmit(Widget.getData());
            });

            JFCustomWidget.subscribe("reset", function () {
                Widget.clearValues();
            });
        });
    </script>
</body>
</html>